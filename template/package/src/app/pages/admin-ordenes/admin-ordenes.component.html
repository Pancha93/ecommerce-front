<mat-card class="cardWithShadow">
  <mat-card-header>
    <mat-card-title>
      <h2 class="m-0">Gestión de Órdenes</h2>
    </mat-card-title>
  </mat-card-header>
  <mat-card-content class="p-24">
    
    <!-- Filtros y búsqueda -->
    <div class="d-flex justify-content-between align-items-center mb-3" *ngIf="!mostrarDetalles">
      <div class="d-flex gap-2">
        <button mat-stroked-button (click)="filtrarPorEstado('TODAS')">
          Todas
        </button>
        <button mat-stroked-button *ngFor="let estado of estadosDisponibles" 
                (click)="filtrarPorEstado(estado.valor)"
                [color]="estado.color">
          {{ estado.etiqueta }}
        </button>
      </div>
      
      <mat-form-field appearance="outline" class="w-25">
        <mat-label>Buscar orden</mat-label>
        <input matInput (keyup)="aplicarFiltro($event)" placeholder="Número de orden, cliente...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <!-- Detalles de la orden -->
    <div *ngIf="mostrarDetalles && ordenSeleccionada" class="mb-4">
      <mat-card>
        <mat-card-header>
          <mat-card-title class="d-flex justify-content-between align-items-center w-100">
            <span>Detalles de la Orden {{ ordenSeleccionada.numeroOrden }}</span>
            <button mat-icon-button (click)="cerrarDetalles()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="pt-3">
          <div class="row">
            <div class="col-md-6">
              <h3>Información General</h3>
              <p><strong>Número de Orden:</strong> {{ ordenSeleccionada.numeroOrden }}</p>
              <p><strong>Cliente:</strong> {{ ordenSeleccionada.usuarioNombre }}</p>
              <p><strong>Fecha:</strong> {{ formatearFecha(ordenSeleccionada.fechaCreacion) }}</p>
              <p><strong>Estado:</strong> 
                <mat-chip [color]="obtenerColorEstado(ordenSeleccionada.estado)" selected>
                  {{ obtenerEtiquetaEstado(ordenSeleccionada.estado) }}
                </mat-chip>
              </p>
              <p><strong>Método de Pago:</strong> {{ ordenSeleccionada.metodoPago || 'N/A' }}</p>
            </div>

            <div class="col-md-6" *ngIf="ordenSeleccionada.direccionEnvio">
              <h3>Dirección de Envío</h3>
              <p><strong>{{ ordenSeleccionada.direccionEnvio.nombreCompleto }}</strong></p>
              <p>{{ ordenSeleccionada.direccionEnvio.direccionLinea1 }}</p>
              <p *ngIf="ordenSeleccionada.direccionEnvio.direccionLinea2">
                {{ ordenSeleccionada.direccionEnvio.direccionLinea2 }}
              </p>
              <p>{{ ordenSeleccionada.direccionEnvio.ciudad }}, 
                 {{ ordenSeleccionada.direccionEnvio.estadoProvincia }} 
                 {{ ordenSeleccionada.direccionEnvio.codigoPostal }}</p>
              <p>{{ ordenSeleccionada.direccionEnvio.pais }}</p>
              <p><strong>Teléfono:</strong> {{ ordenSeleccionada.direccionEnvio.telefono }}</p>
            </div>

            <div class="col-12 mt-3">
              <h3>Productos</h3>
              <table class="table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th class="text-center">Cantidad</th>
                    <th class="text-end">Precio Unitario</th>
                    <th class="text-end">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of ordenSeleccionada.items">
                    <td>{{ item.productoNombre }}</td>
                    <td class="text-center">{{ item.cantidad }}</td>
                    <td class="text-end">${{ item.precioUnitario | number:'1.2-2' }}</td>
                    <td class="text-end">${{ item.subtotal | number:'1.2-2' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="col-12 mt-3">
              <div class="d-flex flex-column align-items-end">
                <p><strong>Subtotal:</strong> ${{ ordenSeleccionada.subtotal | number:'1.2-2' }}</p>
                <p><strong>Costo de Envío:</strong> ${{ ordenSeleccionada.costoEnvio | number:'1.2-2' }}</p>
                <p *ngIf="ordenSeleccionada.impuestos > 0">
                  <strong>Impuestos:</strong> ${{ ordenSeleccionada.impuestos | number:'1.2-2' }}
                </p>
                <h3><strong>Total:</strong> ${{ ordenSeleccionada.total | number:'1.2-2' }}</h3>
              </div>
            </div>

            <div class="col-12 mt-3" *ngIf="ordenSeleccionada.notas">
              <h3>Notas</h3>
              <p>{{ ordenSeleccionada.notas }}</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Tabla de órdenes -->
    <div *ngIf="!mostrarDetalles" class="table-responsive">
      <table mat-table [dataSource]="dataSource" class="w-100">
        
        <!-- Número de Orden Column -->
        <ng-container matColumnDef="numeroOrden">
          <th mat-header-cell *matHeaderCellDef>Número de Orden</th>
          <td mat-cell *matCellDef="let orden">
            <strong>{{ orden.numeroOrden }}</strong>
          </td>
        </ng-container>

        <!-- Fecha Column -->
        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let orden">
            {{ formatearFecha(orden.fechaCreacion) }}
          </td>
        </ng-container>

        <!-- Cliente Column -->
        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef>Cliente</th>
          <td mat-cell *matCellDef="let orden">{{ orden.usuarioNombre || 'N/A' }}</td>
        </ng-container>

        <!-- Items Column -->
        <ng-container matColumnDef="items">
          <th mat-header-cell *matHeaderCellDef>Items</th>
          <td mat-cell *matCellDef="let orden">
            <mat-chip>{{ calcularTotalItems(orden) }} items</mat-chip>
          </td>
        </ng-container>

        <!-- Total Column -->
        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef>Total</th>
          <td mat-cell *matCellDef="let orden">
            <strong>${{ orden.total | number:'1.2-2' }}</strong>
          </td>
        </ng-container>

        <!-- Estado Column -->
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let orden">
            <mat-form-field appearance="outline" class="estado-select">
              <mat-select [value]="orden.estado" 
                          (selectionChange)="cambiarEstado(orden, $event.value)"
                          [disabled]="cargando">
                <mat-option *ngFor="let estado of estadosDisponibles" [value]="estado.valor">
                  {{ estado.etiqueta }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Acciones Column -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let orden">
            <button mat-icon-button color="primary" (click)="verDetalles(orden)" [disabled]="cargando">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- Row shown when there is no data -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center py-4" [attr.colspan]="displayedColumns.length">
            <div *ngIf="!cargando">No se encontraron órdenes</div>
            <div *ngIf="cargando">
              <mat-spinner diameter="40" class="mx-auto"></mat-spinner>
            </div>
          </td>
        </tr>
      </table>
    </div>

  </mat-card-content>
</mat-card>
